<!doctype html>
<html lang="zh-CN" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ site.title }}</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A//www.w3.org/2000/svg'%20viewBox%3D'0%200%2016%2016'%3E%3Crect%20width%3D'16'%20height%3D'16'%20fill%3D'none'/%3E%3C/svg%3E" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="static/styles.css{% if build_version %}?v={{ build_version }}{% endif %}" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg border-bottom">
      <div class="container-fluid">
        <div class="navbar-brand d-flex flex-column lh-sm">
          <span class="fw-semibold">{{ site.brand_en or 'SentiX' }}</span>
          <small class="text-body-secondary">{{ site.brand_zh or '深意·X' }}</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <small class="text-body-secondary" id="updatedAt">{{ latest.updated_at }}</small>
          <button class="btn btn-outline-secondary btn-sm" id="themeToggle" type="button">暗色模式</button>
        </div>
      </div>
    </nav>

    <main class="container py-3">
      <div class="d-flex flex-wrap justify-content-between align-items-end gap-2">
        <div>
          <div class="h4 mb-1">市场情绪概览</div>
          <div class="text-body-secondary small">{{ latest.date }} 更新</div>
        </div>
        <div class="text-body-secondary small">数据源：新闻 + 市场日线（期货 / A股）</div>
      </div>

      {% if macro %}
        <div class="row g-3 mb-1">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between gap-3 align-items-start">
                  <div>
                    <div class="small text-body-secondary">当日宏观新闻交易情绪</div>
                    {% if macro.status == 'ok' %}
                      <div class="fs-3 fw-semibold sentiment-{{ macro.band }}">{{ '%.2f'|format(macro.index) }}</div>
                      <div class="small text-body-secondary">
                        宏观新闻 {{ macro.news_total }} 条（多 {{ macro.counts.bull }} / 空 {{ macro.counts.bear }} / 中 {{ macro.counts.neutral }}）
                      </div>
                    {% else %}
                      <div class="text-body-secondary">数据更新中：{{ macro.reason }}</div>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <div class="small text-body-secondary">更新</div>
                    <div class="fw-semibold">{{ macro.updated_at }}</div>
                    {% if macro.status == 'ok' %}
                      <div class="small text-body-secondary">置信度 {{ '%.2f'|format(macro.confidence) }} · {{ macro.mode }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      {% set futures_symbols = latest.symbols|selectattr('asset', 'equalto', 'futures')|list %}
      {% set stock_symbols = latest.symbols|selectattr('asset', 'equalto', 'stock')|list %}
      {% set legacy_symbols = latest.symbols|selectattr('asset', 'undefined')|list %}
      {% if legacy_symbols %}{% set futures_symbols = futures_symbols + legacy_symbols %}{% endif %}

      <div class="row g-3 mt-1">
        <div class="col-12 col-lg-6">
          {% if macro %}
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between gap-3 align-items-start">
                  <div>
                    <div class="small text-body-secondary">当日宏观新闻情绪</div>
                    {% if macro.status == 'ok' %}
                      <div class="fs-2 fw-semibold sentiment-{{ macro.band }}">{{ '%.2f'|format(macro.index) }}</div>
                      <div class="small text-body-secondary">宏观新闻 {{ macro.news_total }} 条（多 {{ macro.counts.bull }} / 空 {{ macro.counts.bear }} / 中 {{ macro.counts.neutral }}）</div>
                    {% else %}
                      <div class="text-body-secondary">数据更新中：{{ macro.reason }}</div>
                    {% endif %}
                  </div>
                  <div class="text-end">
                    <div class="small text-body-secondary">更新</div>
                    <div class="fw-semibold">{{ macro.updated_at }}</div>
                    {% if macro.status == 'ok' %}
                      <div class="small text-body-secondary">置信度 {{ '%.2f'|format(macro.confidence) }} · {{ macro.mode }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <div class="card shadow-sm"><div class="card-body text-body-secondary">宏观数据更新中</div></div>
          {% endif %}
        </div>

        <div class="col-12 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small text-body-secondary">说明</div>
              <div class="fw-semibold">情绪指数来自新闻衰减加权；市场数据来自日线</div>
              <div class="text-body-secondary small mt-1">点击行可进入详情页查看 K线、成交量、新闻与（期货）基本面模块。</div>
            </div>
          </div>
        </div>
      </div>

      {% macro market_table(items, label) %}
        <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mt-4">
          <div class="h5 mb-0">{{ label }}</div>
          <div class="text-body-secondary small">{{ items|length }} 个标的</div>
        </div>
        <div class="card shadow-sm mt-2">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0 align-middle">
                <thead>
                  <tr class="text-body-secondary">
                    <th>标的</th>
                    <th class="text-end">情绪</th>
                    <th class="text-end">涨跌幅</th>
                    <th class="text-end">收盘</th>
                    <th class="text-end">换手</th>
                    <th class="text-end">成交额</th>
                    <th class="text-end">数据日</th>
                    <th class="text-end">状态</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in items %}
                    <tr>
                      <td>
                        <a class="text-decoration-none fw-semibold" href="s/{{ s.id }}.html">{{ s.name }}</a>
                        <div class="small text-body-secondary">{{ s.id }}</div>
                      </td>
                      <td class="text-end fw-semibold sentiment-{{ s.sentiment_band }}">{{ '%.2f'|format(s.sentiment_index) }}</td>
                      <td class="text-end">
                        {% if s.pct_change is not none %}
                          <span class="fw-semibold pct-{{ 'up' if s.pct_change > 0 else 'down' if s.pct_change < 0 else 'flat' }}">{{ '%.2f'|format(s.pct_change) }}%</span>
                        {% else %}
                          <span class="text-body-secondary">--</span>
                        {% endif %}
                      </td>
                      <td class="text-end">{{ '--' if s.close is none else s.close }}</td>
                      <td class="text-end">
                        {% if s.turnover_rate is defined and s.turnover_rate is not none %}
                          {{ '%.2f'|format(s.turnover_rate) }}%
                        {% else %}
                          --
                        {% endif %}
                      </td>
                      <td class="text-end">
                        {% if s.amount is defined and s.amount is not none %}
                          {{ s.amount }}
                        {% else %}
                          --
                        {% endif %}
                      </td>
                      <td class="text-end text-body-secondary">{{ s.data_date }}</td>
                      <td class="text-end">
                        {% if s.is_stale %}
                          <span class="badge text-bg-warning">更新中</span>
                        {% elif s.price_status and s.price_status != 'ok' %}
                          <span class="badge text-bg-secondary">不可用</span>
                        {% else %}
                          <span class="badge text-bg-light border">OK</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endmacro %}

      {% if futures_symbols %}
        {{ market_table(futures_symbols, '期货') }}
      {% endif %}
      {% if stock_symbols %}
        {{ market_table(stock_symbols, 'A股') }}
      {% endif %}

      {% if not latest.symbols %}
        <div class="card mt-3">
          <div class="card-body">
            <div class="placeholder-glow">
              <span class="placeholder col-6"></span>
              <span class="placeholder col-4"></span>
              <span class="placeholder col-8"></span>
            </div>
            <div class="text-body-secondary mt-2">数据更新中</div>
          </div>
        </div>
      {% endif %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>window.__BASE_PATH__ = {{ base_path|tojson }};</script>
    <script src="static/app.js{% if build_version %}?v={{ build_version }}{% endif %}"></script>
  </body>
</html>
